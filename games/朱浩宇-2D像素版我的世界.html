<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2D像素版我的世界</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#4CAF50',
                        secondary: '#8D6E63',
                        accent: '#FFC107',
                        dark: '#212121',
                        light: '#F5F5F5',
                    },
                    fontFamily: {
                        pixel: ['"Press Start 2P"', 'cursive', 'system-ui'],
                    },
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .pixel-borders {
                box-shadow: 0 -4px 0 0 rgba(0, 0, 0, 0.2), 0 4px 0 0 rgba(0, 0, 0, 0.2), 
                            -4px 0 0 0 rgba(0, 0, 0, 0.2), 4px 0 0 0 rgba(0, 0, 0, 0.2);
            }
            .pixel-btn {
                @apply bg-primary hover:bg-primary/80 text-white font-bold py-2 px-4 rounded transition-all duration-100 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-primary/50;
                box-shadow: 0 4px 0 0 rgba(0, 0, 0, 0.2);
            }
            .pixel-btn:active {
                transform: translateY(4px);
                box-shadow: 0 0 0 0 rgba(0, 0, 0, 0.2);
            }
            .pixel-item {
                @apply relative bg-light border-2 border-dark rounded hover:border-accent transition-all duration-100 cursor-pointer;
                box-shadow: 0 2px 0 0 rgba(0, 0, 0, 0.2);
            }
            .pixel-item.active {
                @apply border-accent bg-accent/20;
                box-shadow: 0 0 0 2px rgba(255, 193, 7, 0.5);
            }
            .pixel-item-count {
                @apply absolute bottom-0 right-0 bg-dark text-white text-xs px-1 rounded;
            }
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
</head>
<body class="bg-dark text-light min-h-screen flex flex-col">
<!-- 返回主页按钮 -->
<div id="homeNavigation" style="position: fixed; top: 20px; left: 20px; z-index: 9999;">
    <a href="../index.html" 
       style="display: inline-flex; align-items: center; gap: 8px; 
              background: linear-gradient(135deg, #FF6B6B, #4ECDC4); 
              color: white; padding: 12px 20px; border-radius: 25px; 
              text-decoration: none; font-family: 'Microsoft YaHei', sans-serif; 
              font-weight: bold; font-size: 14px; 
              box-shadow: 0 4px 15px rgba(0,0,0,0.2); 
              transition: all 0.3s ease;
              backdrop-filter: blur(10px);"
       onmouseover="this.style.transform='translateY(-2px) scale(1.05)'; this.style.boxShadow='0 6px 20px rgba(0,0,0,0.3)';"
       onmouseout="this.style.transform='translateY(0) scale(1)'; this.style.boxShadow='0 4px 15px rgba(0,0,0,0.2)';">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
            <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/>
        </svg>
        返回星球工坊
    </a>
</div>

    <!-- 顶部导航栏 -->
    <header class="bg-dark/80 backdrop-blur-sm py-3 px-4 border-b-2 border-primary/30 sticky top-0 z-50">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <i class="fa fa-cubes text-primary text-xl"></i>
                <h1 class="font-pixel text-primary text-lg tracking-wider">像素世界</h1>
            </div>
            <div class="flex items-center space-x-4">
                <button id="saveBtn" class="pixel-btn hidden md:flex items-center space-x-1">
                    <i class="fa fa-save"></i>
                    <span>保存</span>
                </button>
                <button id="helpBtn" class="pixel-btn hidden md:flex items-center space-x-1">
                    <i class="fa fa-question-circle"></i>
                    <span>帮助</span>
                </button>
                <button id="mobileMenuBtn" class="md:hidden pixel-btn">
                    <i class="fa fa-bars"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- 游戏主区域 -->
    <main class="flex-1 flex flex-col md:flex-row">
        <!-- 侧边栏（移动端在菜单中显示） -->
        <aside id="sidebar" class="bg-dark/90 backdrop-blur-sm w-full md:w-64 border-r-2 border-primary/30 p-4 hidden md:block">
            <div class="space-y-4">
                <div class="bg-dark/50 rounded-lg p-3 border border-primary/20">
                    <h2 class="font-pixel text-sm text-primary mb-2">游戏状态</h2>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between items-center">
                            <span>生命值:</span>
                            <div class="flex">
                                <i class="fa fa-heart text-red-500"></i>
                                <i class="fa fa-heart text-red-500"></i>
                                <i class="fa fa-heart text-red-500"></i>
                                <i class="fa fa-heart text-red-500"></i>
                                <i class="fa fa-heart text-red-500"></i>
                            </div>
                        </div>
                        <div class="flex justify-between items-center">
                            <span>饥饿值:</span>
                            <div class="flex">
                                <i class="fa fa-cutlery text-yellow-500"></i>
                                <i class="fa fa-cutlery text-yellow-500"></i>
                                <i class="fa fa-cutlery text-yellow-500"></i>
                                <i class="fa fa-cutlery text-gray-500"></i>
                                <i class="fa fa-cutlery text-gray-500"></i>
                            </div>
                        </div>
                        <div class="flex justify-between items-center">
                            <span>坐标:</span>
                            <span id="playerCoords" class="text-accent">X: 0, Y: 0</span>
                        </div>
                    </div>
                </div>

                <div class="bg-dark/50 rounded-lg p-3 border border-primary/20">
                    <h2 class="font-pixel text-sm text-primary mb-2">物品栏</h2>
                    <div id="inventory" class="grid grid-cols-3 gap-2">
                        <!-- 物品将通过JS动态生成 -->
                    </div>
                </div>

                <div class="bg-dark/50 rounded-lg p-3 border border-primary/20">
                    <h2 class="font-pixel text-sm text-primary mb-2">工具</h2>
                    <div class="grid grid-cols-2 gap-2">
                        <button id="pickaxeBtn" class="pixel-btn flex items-center justify-center py-1 text-sm">
                            <i class="fa fa-pickaxe mr-1"></i>镐子
                        </button>
                        <button id="shovelBtn" class="pixel-btn flex items-center justify-center py-1 text-sm">
                            <i class="fa fa-shovel mr-1"></i>铲子
                        </button>
                        <button id="axeBtn" class="pixel-btn flex items-center justify-center py-1 text-sm">
                            <i class="fa fa-axe mr-1"></i>斧头
                        </button>
                        <button id="swordBtn" class="pixel-btn flex items-center justify-center py-1 text-sm">
                            <i class="fa fa-sword mr-1"></i>剑
                        </button>
                    </div>
                </div>

                <div class="bg-dark/50 rounded-lg p-3 border border-primary/20">
                    <h2 class="font-pixel text-sm text-primary mb-2">游戏设置</h2>
                    <div class="space-y-2">
                        <div class="flex items-center justify-between">
                            <span class="text-sm">声音</span>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="soundToggle" class="sr-only peer" checked>
                                <div class="w-9 h-5 bg-gray-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-primary"></div>
                            </label>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-sm">画质</span>
                            <select id="qualitySelect" class="bg-dark border border-primary/30 rounded px-2 py-1 text-sm">
                                <option value="low">低</option>
                                <option value="medium" selected>中</option>
                                <option value="high">高</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </aside>

        <!-- 游戏画布区域 -->
        <div class="flex-1 flex flex-col items-center justify-center p-4 relative">
            <div class="relative pixel-borders bg-black rounded-lg overflow-hidden">
                <canvas id="gameCanvas" class="block"></canvas>
                
                <!-- 游戏加载中遮罩 -->
                <div id="loadingScreen" class="absolute inset-0 bg-dark/90 flex flex-col items-center justify-center z-10">
                    <div class="w-32 h-32 border-4 border-primary rounded-full flex items-center justify-center mb-4">
                        <i class="fa fa-cube text-primary text-4xl animate-spin"></i>
                    </div>
                    <h2 class="font-pixel text-primary text-lg mb-2">加载世界中...</h2>
                    <div class="w-64 h-4 bg-dark border border-primary/30 rounded overflow-hidden">
                        <div id="loadingBar" class="h-full bg-primary" style="width: 0%"></div>
                    </div>
                    <p id="loadingText" class="text-sm mt-2 text-gray-400">准备地形数据...</p>
                </div>
                
                <!-- 游戏暂停菜单 -->
                <div id="pauseMenu" class="absolute inset-0 bg-dark/80 flex flex-col items-center justify-center z-10 hidden">
                    <h2 class="font-pixel text-primary text-2xl mb-6">游戏暂停</h2>
                    <div class="space-y-3 w-64">
                        <button id="resumeBtn" class="pixel-btn w-full">继续游戏</button>
                        <button id="saveGameBtn" class="pixel-btn w-full">保存游戏</button>
                        <button id="settingsBtn" class="pixel-btn w-full">游戏设置</button>
                        <button id="exitBtn" class="pixel-btn w-full bg-red-600">退出游戏</button>
                    </div>
                </div>
                
                <!-- 游戏结束菜单 -->
                <div id="gameOverMenu" class="absolute inset-0 bg-dark/80 flex flex-col items-center justify-center z-10 hidden">
                    <h2 class="font-pixel text-red-500 text-2xl mb-2">游戏结束</h2>
                    <p class="text-gray-300 mb-6">你在像素世界中迷失了方向...</p>
                    <div class="space-y-3 w-64">
                        <button id="restartBtn" class="pixel-btn w-full">重新开始</button>
                        <button id="mainMenuBtn" class="pixel-btn w-full">返回主菜单</button>
                    </div>
                </div>
            </div>
            
            <!-- 移动端物品栏 -->
            <div class="md:hidden fixed bottom-20 left-0 right-0 px-4">
                <div class="bg-dark/80 backdrop-blur-sm rounded-lg p-3 border border-primary/30">
                    <h3 class="font-pixel text-xs text-primary mb-2">物品栏</h3>
                    <div id="mobileInventory" class="grid grid-cols-5 gap-2">
                        <!-- 物品将通过JS动态生成 -->
                    </div>
                </div>
            </div>
            
            <!-- 移动端工具菜单 -->
            <div id="mobileToolMenu" class="md:hidden fixed inset-0 bg-dark/90 z-40 flex flex-col items-center justify-center p-6 hidden">
                <div class="flex justify-end w-full mb-6">
                    <button id="closeToolMenuBtn" class="pixel-btn">
                        <i class="fa fa-times"></i>
                    </button>
                </div>
                <h2 class="font-pixel text-primary text-xl mb-6">选择工具</h2>
                <div class="grid grid-cols-2 gap-4 w-full max-w-md">
                    <button id="mobilePickaxeBtn" class="pixel-btn flex items-center justify-center py-3 text-lg">
                        <i class="fa fa-pickaxe mr-2"></i>镐子
                    </button>
                    <button id="mobileShovelBtn" class="pixel-btn flex items-center justify-center py-3 text-lg">
                        <i class="fa fa-shovel mr-2"></i>铲子
                    </button>
                    <button id="mobileAxeBtn" class="pixel-btn flex items-center justify-center py-3 text-lg">
                        <i class="fa fa-axe mr-2"></i>斧头
                    </button>
                    <button id="mobileSwordBtn" class="pixel-btn flex items-center justify-center py-3 text-lg">
                        <i class="fa fa-sword mr-2"></i>剑
                    </button>
                </div>
            </div>
            
            <!-- 移动端工具栏 -->
            <div class="md:hidden fixed bottom-4 left-0 right-0 px-4 flex justify-between items-center">
                <button id="mobileInventoryBtn" class="bg-dark/80 backdrop-blur-sm rounded-full p-3 border border-primary/30 text-primary">
                    <i class="fa fa-cubes text-xl"></i>
                </button>
                <button id="mobileToolBtn" class="bg-dark/80 backdrop-blur-sm rounded-full p-3 border border-primary/30 text-primary">
                    <i class="fa fa-wrench text-xl"></i>
                </button>
                <button id="mobilePauseBtn" class="bg-dark/80 backdrop-blur-sm rounded-full p-3 border border-primary/30 text-primary">
                    <i class="fa fa-pause text-xl"></i>
                </button>
            </div>
        </div>
    </main>

    <!-- 帮助模态框 -->
    <div id="helpModal" class="fixed inset-0 bg-dark/90 z-50 flex items-center justify-center p-4 hidden">
        <div class="bg-dark border-2 border-primary/50 rounded-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-4 border-b border-primary/30 flex justify-between items-center">
                <h2 class="font-pixel text-primary text-xl">游戏帮助</h2>
                <button id="closeHelpBtn" class="text-gray-400 hover:text-white">
                    <i class="fa fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <h3 class="font-pixel text-accent text-sm mb-2">基本控制</h3>
                    <ul class="space-y-2 text-sm">
                        <li class="flex items-center"><kbd class="bg-dark/50 px-2 py-1 rounded border border-primary/30 mr-2">W</kbd> 前进</li>
                        <li class="flex items-center"><kbd class="bg-dark/50 px-2 py-1 rounded border border-primary/30 mr-2">S</kbd> 后退</li>
                        <li class="flex items-center"><kbd class="bg-dark/50 px-2 py-1 rounded border border-primary/30 mr-2">A</kbd> 向左移动</li>
                        <li class="flex items-center"><kbd class="bg-dark/50 px-2 py-1 rounded border border-primary/30 mr-2">D</kbd> 向右移动</li>
                        <li class="flex items-center"><kbd class="bg-dark/50 px-2 py-1 rounded border border-primary/30 mr-2">空格</kbd> 跳跃</li>
                        <li class="flex items-center"><kbd class="bg-dark/50 px-2 py-1 rounded border border-primary/30 mr-2">鼠标左键</kbd> 破坏方块</li>
                        <li class="flex items-center"><kbd class="bg-dark/50 px-2 py-1 rounded border border-primary/30 mr-2">鼠标右键</kbd> 放置方块</li>
                        <li class="flex items-center"><kbd class="bg-dark/50 px-2 py-1 rounded border border-primary/30 mr-2">1-9</kbd> 选择物品栏中的物品</li>
                        <li class="flex items-center"><kbd class="bg-dark/50 px-2 py-1 rounded border border-primary/30 mr-2">ESC</kbd> 暂停游戏</li>
                    </ul>
                </div>
                
                <div>
                    <h3 class="font-pixel text-accent text-sm mb-2">游戏目标</h3>
                    <p class="text-sm">在这个像素世界中，你可以自由探索、收集资源、建造建筑和与环境互动。挖掘不同类型的方块，收集资源，制作工具和武器，建造属于你的家园！</p>
                </div>
                
                <div>
                    <h3 class="font-pixel text-accent text-sm mb-2">方块类型</h3>
                    <div class="grid grid-cols-2 sm:grid-cols-3 gap-4">
                        <div class="flex items-center">
                            <div class="w-8 h-8 bg-green-700 border border-dark mr-2"></div>
                            <span class="text-sm">草方块</span>
                        </div>
                        <div class="flex items-center">
                            <div class="w-8 h-8 bg-yellow-800 border border-dark mr-2"></div>
                            <span class="text-sm">泥土</span>
                        </div>
                        <div class="flex items-center">
                            <div class="w-8 h-8 bg-gray-600 border border-dark mr-2"></div>
                            <span class="text-sm">石头</span>
                        </div>
                        <div class="flex items-center">
                            <div class="w-8 h-8 bg-brown-800 border border-dark mr-2"></div>
                            <span class="text-sm">木头</span>
                        </div>
                        <div class="flex items-center">
                            <div class="w-8 h-8 bg-brown-600 border border-dark mr-2"></div>
                            <span class="text-sm">树叶</span>
                        </div>
                        <div class="flex items-center">
                            <div class="w-8 h-8 bg-blue-700 border border-dark mr-2"></div>
                            <span class="text-sm">水</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 游戏脚本 -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 游戏配置
            const config = {
                blockSize: 32, // 方块大小（像素）
                worldWidth: 100, // 世界宽度（方块数）
                worldHeight: 20, // 世界高度（方块数）
                viewportWidth: 16, // 视口宽度（方块数）
                viewportHeight: 12, // 视口高度（方块数）
                playerSpeed: 4, // 玩家移动速度
                jumpForce: 12, // 跳跃力度
                gravity: 0.5, // 重力
                chunkSize: 16, // 区块大小（方块数）
                seed: Math.random(), // 世界种子
            };
            
            // 方块类型
            const BLOCK_TYPES = {
                AIR: 0,
                GRASS: 1,
                DIRT: 2,
                STONE: 3,
                WOOD: 4,
                LEAVES: 5,
                WATER: 6,
                SAND: 7,
                COAL: 8,
                IRON: 9,
                GOLD: 10,
                DIAMOND: 11,
            };
            
            // 方块属性
            const BLOCK_PROPERTIES = {
                [BLOCK_TYPES.AIR]: { name: "空气", hardness: 0, breakable: false, color: "transparent" },
                [BLOCK_TYPES.GRASS]: { name: "草方块", hardness: 0.6, breakable: true, color: "#228B22" },
                [BLOCK_TYPES.DIRT]: { name: "泥土", hardness: 0.5, breakable: true, color: "#8B4513" },
                [BLOCK_TYPES.STONE]: { name: "石头", hardness: 1.5, breakable: true, color: "#708090" },
                [BLOCK_TYPES.WOOD]: { name: "木头", hardness: 2.0, breakable: true, color: "#8B5A2B" },
                [BLOCK_TYPES.LEAVES]: { name: "树叶", hardness: 0.2, breakable: true, color: "#32CD32" },
                [BLOCK_TYPES.WATER]: { name: "水", hardness: 100, breakable: false, color: "#1E90FF", liquid: true },
                [BLOCK_TYPES.SAND]: { name: "沙子", hardness: 0.5, breakable: true, color: "#F5DEB3" },
                [BLOCK_TYPES.COAL]: { name: "煤矿", hardness: 3.0, breakable: true, color: "#2C3539" },
                [BLOCK_TYPES.IRON]: { name: "铁矿", hardness: 3.0, breakable: true, color: "#C0C0C0" },
                [BLOCK_TYPES.GOLD]: { name: "金矿", hardness: 3.0, breakable: true, color: "#FFD700" },
                [BLOCK_TYPES.DIAMOND]: { name: "钻石矿", hardness: 3.0, breakable: true, color: "#00FFFF" },
            };
            
            // 工具类型
            const TOOL_TYPES = {
                HAND: 0,
                PICKAXE: 1,
                SHOVEL: 2,
                AXE: 3,
                SWORD: 4,
            };
            
            // 工具属性
            const TOOL_PROPERTIES = {
                [TOOL_TYPES.HAND]: { name: "徒手", efficiency: 1, damage: 1 },
                [TOOL_TYPES.PICKAXE]: { name: "镐子", efficiency: 2, damage: 2, effectiveBlocks: [BLOCK_TYPES.STONE, BLOCK_TYPES.COAL, BLOCK_TYPES.IRON, BLOCK_TYPES.GOLD, BLOCK_TYPES.DIAMOND] },
                [TOOL_TYPES.SHOVEL]: { name: "铲子", efficiency: 2, damage: 1, effectiveBlocks: [BLOCK_TYPES.GRASS, BLOCK_TYPES.DIRT, BLOCK_TYPES.SAND] },
                [TOOL_TYPES.AXE]: { name: "斧头", efficiency: 2, damage: 2, effectiveBlocks: [BLOCK_TYPES.WOOD, BLOCK_TYPES.LEAVES] },
                [TOOL_TYPES.SWORD]: { name: "剑", efficiency: 1, damage: 4 },
            };
            
            // 玩家状态
            const player = {
                x: config.worldWidth / 2,
                y: 0,
                width: 0.8, // 玩家宽度（方块单位）
                height: 1.8, // 玩家高度（方块单位）
                velocityX: 0,
                velocityY: 0,
                isJumping: false,
                isOnGround: false,
                selectedBlock: BLOCK_TYPES.GRASS,
                selectedTool: TOOL_TYPES.HAND,
                inventory: {
                    [BLOCK_TYPES.GRASS]: 10,
                    [BLOCK_TYPES.DIRT]: 20,
                    [BLOCK_TYPES.STONE]: 15,
                    [BLOCK_TYPES.WOOD]: 5,
                },
                tools: {
                    [TOOL_TYPES.HAND]: true,
                    [TOOL_TYPES.PICKAXE]: true,
                    [TOOL_TYPES.SHOVEL]: true,
                    [TOOL_TYPES.AXE]: true,
                    [TOOL_TYPES.SWORD]: true,
                },
                health: 100,
                hunger: 100,
            };
            
            // 游戏状态
            const gameState = {
                world: [], // 世界数据
                isPaused: false,
                isGameOver: false,
                isLoading: true,
                loadingProgress: 0,
                loadingText: "准备地形数据...",
                currentTool: TOOL_TYPES.HAND,
                keys: {
                    w: false,
                    a: false,
                    s: false,
                    d: false,
                    space: false,
                },
                mouse: {
                    x: 0,
                    y: 0,
                    isDown: false,
                    lastDown: false,
                    isRightDown: false,
                    lastRightDown: false,
                },
                viewportX: 0, // 视口X坐标（方块单位）
                viewportY: 0, // 视口Y坐标（方块单位）
                time: 0, // 游戏时间
                dayCycle: 0, // 昼夜循环（0-1）
            };
            
            // 初始化画布
            const canvas = document.getElementById('gameCanvas');
            const ctx = canvas.getContext('2d');
            
            // 设置画布尺寸
            function resizeCanvas() {
                const container = canvas.parentElement;
                const containerWidth = container.clientWidth;
                const containerHeight = container.clientHeight;
                
                // 计算适合容器的画布尺寸
                const blockSize = Math.min(
                    Math.floor(containerWidth / config.viewportWidth),
                    Math.floor(containerHeight / config.viewportHeight)
                );
                
                // 确保方块尺寸是偶数，保持像素对齐
                config.blockSize = blockSize % 2 === 0 ? blockSize : blockSize - 1;
                
                // 设置画布尺寸
                canvas.width = config.viewportWidth * config.blockSize;
                canvas.height = config.viewportHeight * config.blockSize;
            }
            
            // 生成世界
            function generateWorld() {
                // 初始化世界数组
                gameState.world = Array(config.worldHeight).fill().map(() => Array(config.worldWidth).fill(BLOCK_TYPES.AIR));
                
                // 使用种子初始化随机数生成器
                const seed = config.seed;
                const rand = new Random(seed);
                
                // 生成地形
                for (let x = 0; x < config.worldWidth; x++) {
                    // 使用柏林噪声生成地形高度
                    const noise = perlinNoise(x / 20, 0, 0);
                    const surfaceHeight = Math.floor(config.worldHeight * 0.6) + Math.floor(noise * 5);
                    
                    // 生成水面
                    const waterLevel = Math.floor(config.worldHeight * 0.65);
                    
                    // 生成方块
                    for (let y = 0; y < config.worldHeight; y++) {
                        if (y < surfaceHeight - 3) {
                            // 基岩和深层石头
                            if (y < 2) {
                                gameState.world[y][x] = BLOCK_TYPES.STONE;
                            } else {
                                // 生成矿石
                                const oreNoise = perlinNoise(x / 10, y / 10, 0);
                                if (oreNoise > 0.85) {
                                    gameState.world[y][x] = BLOCK_TYPES.DIAMOND;
                                } else if (oreNoise > 0.75) {
                                    gameState.world[y][x] = BLOCK_TYPES.GOLD;
                                } else if (oreNoise > 0.6) {
                                    gameState.world[y][x] = BLOCK_TYPES.IRON;
                                } else if (oreNoise > 0.4) {
                                    gameState.world[y][x] = BLOCK_TYPES.COAL;
                                } else {
                                    gameState.world[y][x] = BLOCK_TYPES.STONE;
                                }
                            }
                        } else if (y < surfaceHeight - 1) {
                            // 泥土层
                            gameState.world[y][x] = BLOCK_TYPES.DIRT;
                        } else if (y < surfaceHeight) {
                            // 草方块表面
                            gameState.world[y][x] = BLOCK_TYPES.GRASS;
                        } else if (y <= waterLevel) {
                            // 水
                            gameState.world[y][x] = BLOCK_TYPES.WATER;
                        }
                        
                        // 更新加载进度
                        gameState.loadingProgress = (x + y * config.worldWidth) / (config.worldWidth * config.worldHeight) * 50;
                        updateLoadingScreen();
                    }
                }
                
                // 生成树木
                for (let x = 0; x < config.worldWidth; x += 5) {
                    // 随机决定是否生成树
                    if (rand.random() > 0.7) {
                        const treeX = x + Math.floor(rand.random() * 4);
                        
                        // 找到地面高度
                        let treeY = 0;
                        for (let y = config.worldHeight - 1; y >= 0; y--) {
                            if (gameState.world[y][treeX] === BLOCK_TYPES.GRASS) {
                                treeY = y - 1;
                                break;
                            }
                        }
                        
                        // 确保有足够的空间
                        if (treeY > 3) {
                            // 树干高度
                            const trunkHeight = 4 + Math.floor(rand.random() * 3);
                            
                            // 生成树干
                            for (let y = 0; y < trunkHeight; y++) {
                                gameState.world[treeY - y][treeX] = BLOCK_TYPES.WOOD;
                            }
                            
                            // 生成树叶
                            const leafRadius = 2 + Math.floor(rand.random() * 2);
                            for (let dx = -leafRadius; dx <= leafRadius; dx++) {
                                for (let dy = -leafRadius; dy <= leafRadius; dy++) {
                                    // 圆形树叶
                                    if (dx * dx + dy * dy <= leafRadius * leafRadius + 1) {
                                        const leafX = treeX + dx;
                                        const leafY = treeY - trunkHeight - 1 - dy;
                                        if (leafX >= 0 && leafX < config.worldWidth && leafY >= 0) {
                                            if (gameState.world[leafY][leafX] === BLOCK_TYPES.AIR) {
                                                gameState.world[leafY][leafX] = BLOCK_TYPES.LEAVES;
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                    
                    // 更新加载进度
                    gameState.loadingProgress = 50 + (x / config.worldWidth) * 30;
                    updateLoadingScreen();
                }
                
                // 生成沙子
                for (let x = 0; x < config.worldWidth; x++) {
                    // 找到水面高度
                    let waterY = -1;
                    for (let y = 0; y < config.worldHeight; y++) {
                        if (gameState.world[y][x] === BLOCK_TYPES.WATER) {
                            waterY = y;
                            break;
                        }
                    }
                    
                    // 如果有水面，在水面下生成沙子
                    if (waterY > 0) {
                        // 在水面下2-3层生成沙子
                        for (let y = 1; y <= 3; y++) {
                            if (waterY + y < config.worldHeight) {
                                if (gameState.world[waterY + y][x] === BLOCK_TYPES.DIRT) {
                                    gameState.world[waterY + y][x] = BLOCK_TYPES.SAND;
                                }
                            }
                        }
                    }
                    
                    // 更新加载进度
                    gameState.loadingProgress = 80 + (x / config.worldWidth) * 20;
                    updateLoadingScreen();
                }
                
                // 设置玩家初始位置
                player.x = config.worldWidth / 2;
                for (let y = config.worldHeight - 1; y >= 0; y--) {
                    if (gameState.world[y][Math.floor(player.x)] !== BLOCK_TYPES.AIR) {
                        player.y = y - 2;
                        break;
                    }
                }
                
                // 更新视口位置
                updateViewport();
                
                // 完成加载
                gameState.isLoading = false;
                document.getElementById('loadingScreen').style.display = 'none';
            }
            
            // 更新加载屏幕
            function updateLoadingScreen() {
                document.getElementById('loadingBar').style.width = gameState.loadingProgress + '%';
                document.getElementById('loadingText').textContent = gameState.loadingText;
            }
            
            // 更新视口位置，使玩家居中
            function updateViewport() {
                // 计算视口中心位置
                const viewportCenterX = player.x - config.viewportWidth / 2 + player.width / 2;
                const viewportCenterY = player.y - config.viewportHeight / 2 + player.height / 2;
                
                // 限制视口范围
                gameState.viewportX = Math.max(0, Math.min(viewportCenterX, config.worldWidth - config.viewportWidth));
                gameState.viewportY = Math.max(0, Math.min(viewportCenterY, config.worldHeight - config.viewportHeight));
            }
            
            // 绘制游戏
            function drawGame() {
                // 清空画布
                ctx.fillStyle = getSkyColor();
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // 绘制网格线（调试用）
                if (false) {
                    ctx.strokeStyle = 'rgba(255, 255, 255, 0.1)';
                    ctx.lineWidth = 1;
                    for (let x = 0; x < config.viewportWidth; x++) {
                        ctx.beginPath();
                        ctx.moveTo(x * config.blockSize, 0);
                        ctx.lineTo(x * config.blockSize, canvas.height);
                        ctx.stroke();
                    }
                    for (let y = 0; y < config.viewportHeight; y++) {
                        ctx.beginPath();
                        ctx.moveTo(0, y * config.blockSize);
                        ctx.lineTo(canvas.width, y * config.blockSize);
                        ctx.stroke();
                    }
                }
                
                // 绘制世界
                for (let y = 0; y < config.viewportHeight; y++) {
                    for (let x = 0; x < config.viewportWidth; x++) {
                        // 计算世界坐标
                        const worldX = Math.floor(gameState.viewportX + x);
                        const worldY = Math.floor(gameState.viewportY + y);
                        
                        // 确保坐标在世界范围内
                        if (worldX >= 0 && worldX < config.worldWidth && worldY >= 0 && worldY < config.worldHeight) {
                            const blockType = gameState.world[worldY][worldX];
                            
                            // 只绘制非空气方块
                            if (blockType !== BLOCK_TYPES.AIR) {
                                const blockProps = BLOCK_PROPERTIES[blockType];
                                
                                // 设置方块颜色
                                ctx.fillStyle = blockProps.color;
                                
                                // 绘制方块
                                ctx.fillRect(
                                    x * config.blockSize,
                                    y * config.blockSize,
                                    config.blockSize,
                                    config.blockSize
                                );
                                
                                // 绘制方块边框
                                ctx.strokeStyle = 'rgba(0, 0, 0, 0.3)';
                                ctx.lineWidth = 1;
                                ctx.strokeRect(
                                    x * config.blockSize,
                                    y * config.blockSize,
                                    config.blockSize,
                                    config.blockSize
                                );
                                
                                // 绘制液体透明度
                                if (blockProps.liquid) {
                                    ctx.fillStyle = 'rgba(30, 144, 255, 0.5)';
                                    ctx.fillRect(
                                        x * config.blockSize,
                                        y * config.blockSize,
                                        config.blockSize,
                                        config.blockSize
                                    );
                                }
                            }
                        }
                    }
                }
                
                // 绘制玩家
                ctx.fillStyle = '#FF69B4'; // 粉色
                ctx.fillRect(
                    (player.x - gameState.viewportX) * config.blockSize,
                    (player.y - gameState.viewportY) * config.blockSize,
                    player.width * config.blockSize,
                    player.height * config.blockSize
                );
                
                // 绘制玩家眼睛
                ctx.fillStyle = 'white';
                ctx.fillRect(
                    (player.x - gameState.viewportX + 0.2) * config.blockSize,
                    (player.y - gameState.viewportY + 0.3) * config.blockSize,
                    0.1 * config.blockSize,
                    0.1 * config.blockSize
                );
                ctx.fillRect(
                    (player.x - gameState.viewportX + 0.5) * config.blockSize,
                    (player.y - gameState.viewportY + 0.3) * config.blockSize,
                    0.1 * config.blockSize,
                    0.1 * config.blockSize
                );
                
                // 绘制玩家嘴巴
                ctx.fillStyle = 'black';
                ctx.fillRect(
                    (player.x - gameState.viewportX + 0.25) * config.blockSize,
                    (player.y - gameState.viewportY + 0.6) * config.blockSize,
                    0.3 * config.blockSize,
                    0.05 * config.blockSize
                );
                
                // 绘制玩家手持物品
                const tool = TOOL_PROPERTIES[player.selectedTool];
                ctx.fillStyle = '#CD853F'; // 棕色
                ctx.beginPath();
                ctx.moveTo(
                    (player.x - gameState.viewportX + player.width) * config.blockSize,
                    (player.y - gameState.viewportY + 0.4) * config.blockSize
                );
                ctx.lineTo(
                    (player.x - gameState.viewportX + player.width - 0.3) * config.blockSize,
                    (player.y - gameState.viewportY + 0.2) * config.blockSize
                );
                ctx.lineTo(
                    (player.x - gameState.viewportX + player.width - 0.4) * config.blockSize,
                    (player.y - gameState.viewportY + 0.5) * config.blockSize
                );
                ctx.closePath();
                ctx.fill();
                
                // 如果鼠标按下，绘制破坏动画
                if (gameState.mouse.isDown) {
                    const blockX = Math.floor((gameState.mouse.x / config.blockSize) + gameState.viewportX);
                    const blockY = Math.floor((gameState.mouse.y / config.blockSize) + gameState.viewportY);
                    
                    if (blockX >= 0 && blockX < config.worldWidth && blockY >= 0 && blockY < config.worldHeight) {
                        const blockType = gameState.world[blockY][blockX];
                        
                        if (blockType !== BLOCK_TYPES.AIR) {
                            // 计算破坏进度（简单模拟）
                            const breakProgress = Math.min(1, (gameState.time % 60) / 30);
                            
                            // 绘制破坏进度
                            ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
                            ctx.fillRect(
                                (blockX - gameState.viewportX) * config.blockSize,
                                (blockY - gameState.viewportY) * config.blockSize,
                                config.blockSize,
                                config.blockSize * (1 - breakProgress)
                            );
                            
                            // 绘制破坏等级文本
                            ctx.fillStyle = 'white';
                            ctx.font = '10px Arial';
                            ctx.fillText(
                                Math.ceil(breakProgress * 100) + '%',
                                (blockX - gameState.viewportX) * config.blockSize + 5,
                                (blockY - gameState.viewportY) * config.blockSize + 15
                            );
                        }
                    }
                }
                
                // 绘制选中的方块预览
                if (gameState.mouse.isRightDown) {
                    const blockX = Math.floor((gameState.mouse.x / config.blockSize) + gameState.viewportX);
                    const blockY = Math.floor((gameState.mouse.y / config.blockSize) + gameState.viewportY);
                    
                    if (blockX >= 0 && blockX < config.worldWidth && blockY >= 0 && blockY < config.worldHeight) {
                        const blockType = gameState.world[blockY][blockX];
                        
                        if (blockType === BLOCK_TYPES.AIR) {
                            const selectedBlockProps = BLOCK_PROPERTIES[player.selectedBlock];
                            
                            // 绘制半透明方块预览
                            ctx.fillStyle = selectedBlockProps.color + '80'; // 添加80的alpha值
                            ctx.fillRect(
                                (blockX - gameState.viewportX) * config.blockSize,
                                (blockY - gameState.viewportY) * config.blockSize,
                                config.blockSize,
                                config.blockSize
                            );
                            
                            // 绘制边框
                            ctx.strokeStyle = 'rgba(255, 255, 255, 0.8)';
                            ctx.lineWidth = 2;
                            ctx.strokeRect(
                                (blockX - gameState.viewportX) * config.blockSize,
                                (blockY - gameState.viewportY) * config.blockSize,
                                config.blockSize,
                                config.blockSize
                            );
                        }
                    }
                }
                
                // 更新玩家坐标显示
                document.getElementById('playerCoords').textContent = `X: ${Math.floor(player.x)}, Y: ${Math.floor(player.y)}`;
            }
            
            // 获取天空颜色（根据昼夜循环）
            function getSkyColor() {
                const dayColor = '#87CEEB'; // 天蓝
                const nightColor = '#0F172A'; // 深蓝黑色
                
                // 将dayCycle映射到颜色
                const r1 = parseInt(dayColor.substring(1, 3), 16);
                const g1 = parseInt(dayColor.substring(3, 5), 16);
                const b1 = parseInt(dayColor.substring(5, 7), 16);
                
                const r2 = parseInt(nightColor.substring(1, 3), 16);
                const g2 = parseInt(nightColor.substring(3, 5), 16);
                const b2 = parseInt(nightColor.substring(5, 7), 16);
                
                // 计算插值因子
                let t = gameState.dayCycle;
                if (t > 0.5) t = 1 - t; // 使0和1都是夜晚，0.5是白天
                t = t * 2; // 缩放回0-1
                
                // 线性插值
                const r = Math.floor(r1 + (r2 - r1) * (1 - t));
                const g = Math.floor(g1 + (g2 - g1) * (1 - t));
                const b = Math.floor(b1 + (b2 - b1) * (1 - t));
                
                return `rgb(${r}, ${g}, ${b})`;
            }
            
            // 更新游戏状态
            function updateGame() {
                if (gameState.isPaused || gameState.isGameOver || gameState.isLoading) return;
                
                // 更新游戏时间和昼夜循环
                gameState.time++;
                gameState.dayCycle = (gameState.time % 2400) / 2400;
                
                // 处理玩家输入
                player.velocityX = 0;
                
                if (gameState.keys.d) {
                    player.velocityX += config.playerSpeed;
                }
                if (gameState.keys.a) {
                    player.velocityX -= config.playerSpeed;
                }
                if (gameState.keys.space && player.isOnGround) {
                    player.velocityY = -config.jumpForce;
                    player.isJumping = true;
                    player.isOnGround = false;
                }
                
                // 应用重力
                player.velocityY += config.gravity;
                
                // 限制最大下落速度
                player.velocityY = Math.min(player.velocityY, config.jumpForce);
                
                // 检测碰撞并移动玩家
                movePlayer(player.velocityX, 0);
                movePlayer(0, player.velocityY);
                
                // 处理鼠标点击
                if (gameState.mouse.isDown && !gameState.mouse.lastDown) {
                    // 左键点击 - 破坏方块
                    breakBlock();
                }
                
                if (gameState.mouse.isRightDown && !gameState.mouse.lastRightDown) {
                    // 右键点击 - 放置方块
                    placeBlock();
                }
                
                // 更新鼠标状态
                gameState.mouse.lastDown = gameState.mouse.isDown;
                gameState.mouse.lastRightDown = gameState.mouse.isRightDown;
                
                // 更新视口位置
                updateViewport();
                
                // 更新饥饿度
                if (gameState.time % 600 === 0 && player.hunger > 0) {
                    player.hunger--;
                }
                
                // 更新生命值（如果饥饿）
                if (player.hunger <= 0 && gameState.time % 60 === 0 && player.health > 0) {
                    player.health--;
                    
                    if (player.health <= 0) {
                        gameOver();
                    }
                }
            }
            
            // 移动玩家并处理碰撞
            function movePlayer(dx, dy) {
                // 计算新位置
                let newX = player.x + dx / config.blockSize;
                let newY = player.y + dy / config.blockSize;
                
                // 碰撞检测 - X轴
                if (dx > 0) { // 向右移动
                    // 检查玩家右侧是否有方块
                    const rightX = Math.floor(newX + player.width);
                    const topY = Math.floor(player.y);
                    const bottomY = Math.floor(player.y + player.height);
                    
                    for (let y = topY; y <= bottomY; y++) {
                        if (isSolidBlock(rightX, y)) {
                            newX = Math.floor(newX) - player.width;
                            player.velocityX = 0;
                            break;
                        }
                    }
                } else if (dx < 0) { // 向左移动
                    // 检查玩家左侧是否有方块
                    const leftX = Math.floor(newX);
                    const topY = Math.floor(player.y);
                    const bottomY = Math.floor(player.y + player.height);
                    
                    for (let y = topY; y <= bottomY; y++) {
                        if (isSolidBlock(leftX, y)) {
                            newX = Math.floor(newX) + 1;
                            player.velocityX = 0;
                            break;
                        }
                    }
                }
                
                // 碰撞检测 - Y轴
                player.isOnGround = false;
                if (dy > 0) { // 向下移动（下落）
                    // 检查玩家底部是否有方块
                    const bottomY = Math.floor(newY + player.height);
                    const leftX = Math.floor(newX);
                    const rightX = Math.floor(newX + player.width);
                    
                    for (let x = leftX; x <= rightX; x++) {
                        if (isSolidBlock(x, bottomY)) {
                            newY = Math.floor(newY);
                            player.velocityY = 0;
                            player.isJumping = false;
                            player.isOnGround = true;
                            break;
                        }
                    }
                } else if (dy < 0) { // 向上移动（跳跃）
                    // 检查玩家顶部是否有方块
                    const topY = Math.floor(newY);
                    const leftX = Math.floor(newX);
                    const rightX = Math.floor(newX + player.width);
                    
                    for (let x = leftX; x <= rightX; x++) {
                        if (isSolidBlock(x, topY)) {
                            newY = Math.floor(newY) + player.height;
                            player.velocityY = 0;
                            break;
                        }
                    }
                }
                
                // 更新玩家位置
                player.x = newX;
                player.y = newY;
                
                // 确保玩家不会超出世界边界
                player.x = Math.max(0, Math.min(player.x, config.worldWidth - player.width));
                player.y = Math.max(0, Math.min(player.y, config.worldHeight - player.height));
            }
            
            // 检查方块是否为固体
            function isSolidBlock(x, y) {
                if (x < 0 || x >= config.worldWidth || y < 0 || y >= config.worldHeight) {
                    return false;
                }
                
                const blockType = gameState.world[y][x];
                return blockType !== BLOCK_TYPES.AIR && !BLOCK_PROPERTIES[blockType].liquid;
            }
            
            // 破坏方块
            function breakBlock() {
                const blockX = Math.floor((gameState.mouse.x / config.blockSize) + gameState.viewportX);
                const blockY = Math.floor((gameState.mouse.y / config.blockSize) + gameState.viewportY);
                
                if (blockX >= 0 && blockX < config.worldWidth && blockY >= 0 && blockY < config.worldHeight) {
                    const blockType = gameState.world[blockY][blockX];
                    
                    if (blockType !== BLOCK_TYPES.AIR) {
                        const blockProps = BLOCK_PROPERTIES[blockType];
                        const tool = TOOL_PROPERTIES[player.selectedTool];
                        
                        // 检查工具是否有效
                        let canBreak = true;
                        if (tool.effectiveBlocks && !tool.effectiveBlocks.includes(blockType)) {
                            canBreak = false;
                        }
                        
                        if (canBreak && blockProps.breakable) {
                            // 移除方块
                            gameState.world[blockY][blockX] = BLOCK_TYPES.AIR;
                            
                            // 添加到物品栏
                            if (player.inventory[blockType]) {
                                player.inventory[blockType]++;
                            } else {
                                player.inventory[blockType] = 1;
                            }
                            
                            // 更新物品栏显示
                            updateInventoryDisplay();
                        }
                    }
                }
            }
            
            // 放置方块
            function placeBlock() {
                const blockX = Math.floor((gameState.mouse.x / config.blockSize) + gameState.viewportX);
                const blockY = Math.floor((gameState.mouse.y / config.blockSize) + gameState.viewportY);
                
                if (blockX >= 0 && blockX < config.worldWidth && blockY >= 0 && blockY < config.worldHeight) {
                    const blockType = gameState.world[blockY][blockX];
                    
                    if (blockType === BLOCK_TYPES.AIR && player.inventory[player.selectedBlock] > 0) {
                        // 放置方块
                        gameState.world[blockY][blockX] = player.selectedBlock;
                        
                        // 从物品栏中减去
                        player.inventory[player.selectedBlock]--;
                        
                        // 如果数量为0，从物品栏中移除
                        if (player.inventory[player.selectedBlock] === 0) {
                            delete player.inventory[player.selectedBlock];
                            
                            // 如果移除的是当前选中的方块，选择第一个可用的方块
                            if (Object.keys(player.inventory).length > 0) {
                                player.selectedBlock = parseInt(Object.keys(player.inventory)[0]);
                            } else {
                                player.selectedBlock = BLOCK_TYPES.GRASS;
                                player.inventory[BLOCK_TYPES.GRASS] = 1;
                            }
                        }
                        
                        // 更新物品栏显示
                        updateInventoryDisplay();
                    }
                }
            }
            
            // 更新物品栏显示
            function updateInventoryDisplay() {
                const inventoryContainer = document.getElementById('inventory');
                const mobileInventoryContainer = document.getElementById('mobileInventory');
                
                // 清空现有物品栏
                inventoryContainer.innerHTML = '';
                mobileInventoryContainer.innerHTML = '';
                
                // 添加物品到物品栏
                Object.keys(player.inventory).forEach((blockType, index) => {
                    blockType = parseInt(blockType);
                    const count = player.inventory[blockType];
                    const blockProps = BLOCK_PROPERTIES[blockType];
                    
                    // 创建物品元素
                    const itemElement = document.createElement('div');
                    itemElement.className = `pixel-item ${player.selectedBlock === blockType ? 'active' : ''}`;
                    itemElement.dataset.blockType = blockType;
                    itemElement.innerHTML = `
                        <div class="w-full h-full flex items-center justify-center" style="background-color: ${blockProps.color}">
                            <span class="pixel-item-count">${count}</span>
                        </div>
                    `;
                    
                    // 添加点击事件
                    itemElement.addEventListener('click', () => {
                        player.selectedBlock = blockType;
                        updateInventoryDisplay();
                    });
                    
                    // 添加到桌面和移动物品栏
                    inventoryContainer.appendChild(itemElement.cloneNode(true));
                    mobileInventoryContainer.appendChild(itemElement);
                });
                
                // 添加快捷选择提示
                const keys = ['1', '2', '3', '4', '5', '6', '7', '8', '9'];
                const inventoryItems = mobileInventoryContainer.querySelectorAll('.pixel-item');
                inventoryItems.forEach((item, index) => {
                    if (keys[index]) {
                        const keyHint = document.createElement('div');
                        keyHint.className = 'absolute top-0 left-0 bg-dark text-white text-xs px-1 rounded';
                        keyHint.textContent = keys[index];
                        item.appendChild(keyHint);
                    }
                });
            }
            
            // 游戏结束
            function gameOver() {
                gameState.isGameOver = true;
                document.getElementById('gameOverMenu').style.display = 'flex';
            }
            
            // 游戏主循环
            function gameLoop() {
                updateGame();
                drawGame();
                requestAnimationFrame(gameLoop);
            }
            
            // 初始化随机数生成器（使用固定种子）
            function Random(seed) {
                this.seed = seed;
            }
            
            Random.prototype.random = function() {
                const x = Math.sin(this.seed++) * 10000;
                return x - Math.floor(x);
            };
            
            // 柏林噪声实现（简化版）
            function perlinNoise(x, y, z) {
                // 这是一个简化的柏林噪声实现，实际游戏中应该使用更复杂的实现
                return Math.sin(x) * 0.5 + 0.5;
            }
            
            // 事件监听
            function setupEventListeners() {
                // 键盘事件
                window.addEventListener('keydown', (e) => {
                    if (gameState.isPaused || gameState.isGameOver || gameState.isLoading) return;
                    
                    switch(e.key.toLowerCase()) {
                        case 'w':
                            gameState.keys.w = true;
                            break;
                        case 'a':
                            gameState.keys.a = true;
                            break;
                        case 's':
                            gameState.keys.s = true;
                            break;
                        case 'd':
                            gameState.keys.d = true;
                            break;
                        case ' ':
                            gameState.keys.space = true;
                            break;
                        case '1':
                        case '2':
                        case '3':
                        case '4':
                        case '5':
                        case '6':
                        case '7':
                        case '8':
                        case '9':
                            const index = parseInt(e.key) - 1;
                            const blockTypes = Object.keys(player.inventory);
                            if (blockTypes[index]) {
                                player.selectedBlock = parseInt(blockTypes[index]);
                                updateInventoryDisplay();
                            }
                            break;
                        case 'escape':
                            togglePause();
                            break;
                    }
                });
                
                window.addEventListener('keyup', (e) => {
                    switch(e.key.toLowerCase()) {
                        case 'w':
                            gameState.keys.w = false;
                            break;
                        case 'a':
                            gameState.keys.a = false;
                            break;
                        case 's':
                            gameState.keys.s = false;
                            break;
                        case 'd':
                            gameState.keys.d = false;
                            break;
                        case ' ':
                            gameState.keys.space = false;
                            break;
                    }
                });
                
                // 鼠标事件
                canvas.addEventListener('mousemove', (e) => {
                    const rect = canvas.getBoundingClientRect();
                    gameState.mouse.x = e.clientX - rect.left;
                    gameState.mouse.y = e.clientY - rect.top;
                });
                
                canvas.addEventListener('mousedown', (e) => {
                    if (gameState.isPaused || gameState.isGameOver || gameState.isLoading) return;
                    
                    if (e.button === 0) { // 左键
                        gameState.mouse.isDown = true;
                    } else if (e.button === 2) { // 右键
                        gameState.mouse.isRightDown = true;
                    }
                });
                
                canvas.addEventListener('mouseup', (e) => {
                    if (e.button === 0) { // 左键
                        gameState.mouse.isDown = false;
                    } else if (e.button === 2) { // 右键
                        gameState.mouse.isRightDown = false;
                    }
                });
                
                // 防止右键菜单
                canvas.addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                });
                
                // 窗口大小变化事件
                window.addEventListener('resize', () => {
                    resizeCanvas();
                });
                
                // 工具选择按钮
                document.getElementById('pickaxeBtn').addEventListener('click', () => {
                    player.selectedTool = TOOL_TYPES.PICKAXE;
                });
                
                document.getElementById('shovelBtn').addEventListener('click', () => {
                    player.selectedTool = TOOL_TYPES.SHOVEL;
                });
                
                document.getElementById('axeBtn').addEventListener('click', () => {
                    player.selectedTool = TOOL_TYPES.AXE;
                });
                
                document.getElementById('swordBtn').addEventListener('click', () => {
                    player.selectedTool = TOOL_TYPES.SWORD;
                });
                
                // 移动端工具按钮
                document.getElementById('mobileToolBtn').addEventListener('click', () => {
                    document.getElementById('mobileToolMenu').style.display = 'flex';
                });
                
                document.getElementById('closeToolMenuBtn').addEventListener('click', () => {
                    document.getElementById('mobileToolMenu').style.display = 'none';
                });
                
                document.getElementById('mobilePickaxeBtn').addEventListener('click', () => {
                    player.selectedTool = TOOL_TYPES.PICKAXE;
                    document.getElementById('mobileToolMenu').style.display = 'none';
                });
                
                document.getElementById('mobileShovelBtn').addEventListener('click', () => {
                    player.selectedTool = TOOL_TYPES.SHOVEL;
                    document.getElementById('mobileToolMenu').style.display = 'none';
                });
                
                document.getElementById('mobileAxeBtn').addEventListener('click', () => {
                    player.selectedTool = TOOL_TYPES.AXE;
                    document.getElementById('mobileToolMenu').style.display = 'none';
                });
                
                document.getElementById('mobileSwordBtn').addEventListener('click', () => {
                    player.selectedTool = TOOL_TYPES.SWORD;
                    document.getElementById('mobileToolMenu').style.display = 'none';
                });
                
                // 移动端物品栏按钮
                document.getElementById('mobileInventoryBtn').addEventListener('click', () => {
                    const inventory = document.getElementById('mobileInventory').parentElement;
                    inventory.style.display = inventory.style.display === 'none' ? 'block' : 'none';
                });
                
                // 移动端暂停按钮
                document.getElementById('mobilePauseBtn').addEventListener('click', togglePause);
                
                // 暂停菜单按钮
                document.getElementById('resumeBtn').addEventListener('click', togglePause);
                document.getElementById('saveGameBtn').addEventListener('click', saveGame);
                document.getElementById('settingsBtn').addEventListener('click', () => {
                    alert('游戏设置功能尚未实现');
                });
                document.getElementById('exitBtn').addEventListener('click', exitGame);
                
                // 游戏结束菜单按钮
                document.getElementById('restartBtn').addEventListener('click', restartGame);
                document.getElementById('mainMenuBtn').addEventListener('click', exitGame);
                
                // 保存和帮助按钮
                document.getElementById('saveBtn').addEventListener('click', saveGame);
                document.getElementById('helpBtn').addEventListener('click', () => {
                    document.getElementById('helpModal').style.display = 'flex';
                });
                
                document.getElementById('closeHelpBtn').addEventListener('click', () => {
                    document.getElementById('helpModal').style.display = 'none';
                });
                
                // 点击帮助模态框外部关闭
                document.getElementById('helpModal').addEventListener('click', (e) => {
                    if (e.target === document.getElementById('helpModal')) {
                        document.getElementById('helpModal').style.display = 'none';
                    }
                });
            }
            
            // 切换暂停状态
            function togglePause() {
                gameState.isPaused = !gameState.isPaused;
                document.getElementById('pauseMenu').style.display = gameState.isPaused ? 'flex' : 'none';
            }
            
            // 保存游戏
            function saveGame() {
                try {
                    const saveData = {
                        world: gameState.world,
                        player: {
                            x: player.x,
                            y: player.y,
                            inventory: player.inventory,
                            health: player.health,
                            hunger: player.hunger,
                        },
                        time: gameState.time,
                        dayCycle: gameState.dayCycle,
                    };
                    
                    localStorage.setItem('pixelMinecraftSave', JSON.stringify(saveData));
                    alert('游戏已保存！');
                } catch (e) {
                    console.error('保存游戏失败:', e);
                    alert('保存游戏失败！');
                }
            }
            
            // 加载游戏
            function loadGame() {
                try {
                    const saveData = JSON.parse(localStorage.getItem('pixelMinecraftSave'));
                    
                    if (saveData) {
                        gameState.world = saveData.world;
                        player.x = saveData.player.x;
                        player.y = saveData.player.y;
                        player.inventory = saveData.player.inventory;
                        player.health = saveData.player.health;
                        player.hunger = saveData.player.hunger;
                        gameState.time = saveData.time;
                        gameState.dayCycle = saveData.dayCycle;
                        
                        updateInventoryDisplay();
                        updateViewport();
                        
                        gameState.isLoading = false;
                        document.getElementById('loadingScreen').style.display = 'none';
                        
                        return true;
                    }
                } catch (e) {
                    console.error('加载游戏失败:', e);
                }
                
                return false;
            }
            
            // 重新开始游戏
            function restartGame() {
                document.getElementById('gameOverMenu').style.display = 'none';
                gameState.isGameOver = false;
                gameState.isLoading = true;
                document.getElementById('loadingScreen').style.display = 'flex';
                
                // 重置玩家状态
                player.x = config.worldWidth / 2;
                player.y = 0;
                player.velocityX = 0;
                player.velocityY = 0;
                player.isJumping = false;
                player.isOnGround = false;
                player.selectedBlock = BLOCK_TYPES.GRASS;
                player.selectedTool = TOOL_TYPES.HAND;
                player.inventory = {
                    [BLOCK_TYPES.GRASS]: 10,
                    [BLOCK_TYPES.DIRT]: 20,
                    [BLOCK_TYPES.STONE]: 15,
                    [BLOCK_TYPES.WOOD]: 5,
                };
                player.health = 100;
                player.hunger = 100;
                
                // 重置游戏状态
                gameState.time = 0;
                gameState.dayCycle = 0;
                
                // 生成新的世界
                generateWorld();
                
                // 更新物品栏显示
                updateInventoryDisplay();
            }
            
            // 退出游戏
            function exitGame() {
                alert('游戏已退出，刷新页面重新开始！');
            }
            
            // 初始化游戏
            function initGame() {
                resizeCanvas();
                setupEventListeners();
                
                // 尝试加载游戏
                if (!loadGame()) {
                    // 如果没有保存数据，生成新世界
                    generateWorld();
                }
                
                // 更新物品栏显示
                updateInventoryDisplay();
                
                // 开始游戏循环
                gameLoop();
            }
            
            // 启动游戏
            initGame();
        });
    </script>

<!-- Author Signature Widget V2 -->
<script id="author-signature-widget-v2">
  (function() {
    function showSignature() {
      var authorNameStr = '朱浩宇';

      if (document.getElementById('author-signature-container-v2')) {
        return;
      }

      var container = document.createElement('div');
      container.id = 'author-signature-container-v2';
      container.style.position = 'fixed';
      container.style.top = '50%';
      container.style.left = '50%';
      container.style.transform = 'translate(-50%, -50%) scale(0.7)';
      container.style.padding = '30px 50px';
      container.style.backgroundColor = 'rgba(0, 0, 0, 0.8)';
      container.style.color = 'white';
      container.style.borderRadius = '20px';
      container.style.zIndex = '2147483647';
      container.style.fontFamily = '"PingFang SC", "Helvetica Neue", "Microsoft YaHei", sans-serif';
      container.style.fontSize = '10vw';
      container.style.fontWeight = 'bold';
      container.style.textAlign = 'center';
      container.style.boxShadow = '0 10px 30px rgba(0,0,0,0.5)';
      container.style.opacity = '0';
      container.style.transition = 'opacity 0.5s ease, transform 0.5s ease';
      container.style.whiteSpace = 'nowrap';
      container.style.cursor = 'pointer';

      var textElement = document.createElement('span');
      textElement.textContent = '作者: ' + authorNameStr;

      var hideWidget = function() {
        container.style.transform = 'translate(-50%, -50%) scale(0.7)';
        container.style.opacity = '0';
        setTimeout(function() {
          if (container.parentNode) {
            container.parentNode.removeChild(container);
          }
        }, 500);
      };

      container.onclick = hideWidget;

      container.appendChild(textElement);
      document.body.appendChild(container);

      setTimeout(function() {
        container.style.opacity = '1';
        container.style.transform = 'translate(-50%, -50%) scale(1)';
      }, 50);

      setTimeout(hideWidget, 5000);
    }

    if (document.body) {
        showSignature();
    } else {
        document.addEventListener('DOMContentLoaded', showSignature);
    }
  })();
</script>
</body>
</html>
    